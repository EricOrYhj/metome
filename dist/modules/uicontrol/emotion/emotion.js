define(function(require,exports,module){function t(){return!!(window.devicePixelRatio&&window.devicePixelRatio>1)}function o(t,o){if(t.createTextRange){var e=t.createTextRange();e.move("character",o),e.select()}else o?(t.focus(),t.setSelectionRange(o,o)):t.focus()}function e(t){var o=0;if(document.selection){t.focus();var e=document.selection.createRange(),i=e.duplicate();for(i.moveToElementText(t),o=-1;i.inRange(e);)i.moveStart("character"),o++}else t.setSelectionRange&&(t.focus(),o=t.selectionStart);return o}function i(t,o){this.$el=$(t),o.defaultTab=this.getDefaultTab(o),this.options=$.extend({},i.options,o),this._init()}require("./emotion.css");var n=require("twemoji");n.base="/resource/images/emotion/twemoji/",n.size=72,n.className="emotion-twemoji";var s=require("./data");i.prototype.getDefaultTab=function(t){var o="";return t=t||{},o=t.historyKey||i.options.historyKey,window.localStorage&&window.localStorage[o]?0:1},i.options={input:"",imgPath:"/resource/images/emotion/",defaultTab:0,mdBear:!1,offset:24,history:!0,historySize:40,autoHide:!0,historyKey:"mdEmotion",relatedLeftSpace:0,relatedTopSpace:0,placement:"left top",onSelect:function(){},onMDBearSelect:function(){}},i.prototype._init=function(){this.isOpen=!1,this.$target=$(this.options.input),this.$el.on("click",$.proxy(this.toggle,this)),this.$target.on("keyup",$.proxy(this.hide,this))},i.prototype.emotion=function(){var t=$('<div class="mdEmotion"><span class="arrow"></span> <div class="mdEmotionWrapper"></div><div class="mdEmotionTab"></div></div>'),o="",e="",i=this,n=null;return this.$emotion?n=this.$emotion:($.each(s,function(t,n){!i.options.mdBear&&"明道萌熊"===n.tab.name||!i.options.history&&0===t||(o+='<span class="tip-top tabItem tab'+(t+1)+(t===i.options.defaultTab?" active":"")+'" data-emotion-index="'+t+'" data-tip="'+n.tab.name+'"><i class="'+n.tab.className+'"></i>'+(n.tab.text||"")+"</span>",e+='<div class="mdEmotionPanel panel'+(t+1)+(t===i.options.defaultTab?" active":"")+'"></div>')}),t.find(".mdEmotionTab").html(o).end().find(".mdEmotionWrapper").html(e),n=t,this.$emotion=n,n)},i.prototype.arrow=function(){return this.$arrow=this.$arrow||this.emotion().find(".arrow"),this.$arrow},i.prototype._getPosition=function(){var t={top:0,left:0},o=this.options.placement.split(" "),e=this.$el.offset().top,i=this.emotion().outerHeight()+8,n=this.emotion().outerWidth()+8;return this.$el.length&&(t.left=this.$el.offset().left+this.options.relatedLeftSpace,t.top=this.$el.offset().top,$(window).height()-(e-$(window).scrollTop())<i?this.options.placement=o[0]+" top":this.options.placement=o[0]+" bottom",t.right-n<0&&(this.options.placement="left "+o[1]),o=this.options.placement.split(" "),"left"===o[0]?t.left+=0:"right"===o[0]&&(t.left-=n-this.$el.outerWidth()),"top"===o[1]?t.top-=i:"bottom"===o[1]&&(t.top+=this.$el.outerHeight()+8)),t},i.prototype._setPosition=function(t,o){this.$emotion.removeClass("emotion-top emotion-bottom"),this.$emotion.addClass("emotion-"+this.options.placement.split(" ")[1]);var e=this.options.placement.split(" ")[0];"left"===e?this.arrow().css("left",this.options.offset):"right"==e&&this.arrow().css("left",this.$emotion.outerWidth()-this.options.offset),this.emotion().offset({left:t,top:o})},i.prototype.select=function(t){t.stopPropagation();var i=t.currentTarget.outerHTML,n=t.currentTarget.getElementsByTagName("img")[0].getAttribute("src"),s=$(t.currentTarget),a="";this.options.autoHide&&this.hide(),s.hasClass("emotionItemBear")?(i=i.replace(" active","").replace(".gif",".png"),n=n.replace(".png",".gif"),this._storeHistory(i),"function"==typeof this.options.onMDBearSelect&&this.options.onMDBearSelect.call(this,t.currentTarget.getAttribute("title"),n.replace(this.options.imgPath,""))):s.hasClass("emoji")?(this._storeHistory(i),a=s.attr("title"),"function"==typeof this.options.onSelect&&this.options.onSelect.call(this,t.currentTarget.getAttribute("title"),n)):(this._storeHistory(i),a="["+t.currentTarget.getAttribute("title")+"]","function"==typeof this.options.onSelect&&this.options.onSelect.call(this,t.currentTarget.getAttribute("title"),n));var r=this.$target.val(),c=this.$target.get(0),l=e(c);this.$target.val(r.slice(0,l)+a+r.slice(l));var p=l+a.length;o(c,p),this.$target.focus()},i.prototype._storeHistory=function(t){if(window.localStorage){if(!window.localStorage[this.options.historyKey])return void(window.localStorage[this.options.historyKey]=JSON.stringify([t]));var o=JSON.parse(window.localStorage[this.options.historyKey]),e=$.inArray(t,o);e!==-1&&o.splice(e,1),o.unshift(t),o.length>this.options.historySize&&o.pop(),window.localStorage[this.options.historyKey]=JSON.stringify(o)}},i.prototype.clearHistory=function(){window.localStorage&&(window.localStorage[this.options.historyKey]=[])},i.prototype.show=function(t,o){var e=this;this.$emotion=this.emotion().on("click",".emotionItem",$.proxy(this.select,this)).insertAfter(this.$el).on("click",".mdEmotionTab .tabItem",function(){var t=$(this);return t.hasClass("active")||(t.siblings(".active").removeClass("active").end().addClass("active"),e.emotion().find(".mdEmotionPanel").removeClass("active").eq(t.index()).addClass("active"),e.load(t.data("emotion-index"))),!1}).on("mouseover",".emotionItemBear",function(){var t=$(this).toggleClass("active").find("img");t.attr("src",t.attr("src").replace(".png",".gif"))}).on("mouseout",".emotionItemBear",function(){var t=$(this).toggleClass("active").find("img");t.attr("src",t.attr("src").replace(".gif",".png"))});var i=e._getPosition();return t=t||i.left,o=o||i.top,this._setPosition(t,o),this.load(e.options.defaultTab),$(document).on("click.mdEmotion",function(t){$(t.target).closest(".mdEmotion").length||$.contains(e.$el[0],t.target)||e.$el[0]===t.target||e.hide()}),this.isOpen=!0,this.$emotion},i.prototype.load=function(o){var e=this.emotion().find(".panel"+(o+1)),i=this,a="";i.options.history&&0===o&&window.localStorage&&window.localStorage[this.options.historyKey]&&($.each(JSON.parse(window.localStorage[i.options.historyKey]),function(t,o){(i.options.mdBear||!i.options.mdBear&&o.indexOf("emotionItemBear")===-1)&&(a+=o)}),e.html(a)),e.data("loaded")||("emoji"===s[o].tab.type?$.each(s[o].content,function(t,e){a+='<a class="emotionItem '+s[o].tab.type+'" title="'+e+'">'+n.parse(e)+"</a>"}):$.each(s[o].content,function(e,n){a+='<a class="emotionItem '+("明道萌熊"===s[o].tab.name?"emotionItemBear":"")+'" title="'+n.key+'"><img src="'+i.options.imgPath+s[o].tab.path+(t()&&s[o].tab.showRetina?"retina/":"")+n.img+'"> </a>'}),e.html(a).data("loaded",!0))},i.prototype.hide=function(){this.$emotion&&(this.$emotion.remove(),$(document).off("click.mdEmotion"),this.isOpen=!1)},i.prototype.toggle=function(){this.isOpen?this.hide():this.show()},i.prototype.parse=function(t){return t=t||"",s.forEach(function(o,e){o.content.forEach(function(n,a){var r=new RegExp("\\["+n.key+"\\]","gi");if(t.search(r)>-1){var c=i.options.imgPath+s[e].tab.path+n.img;t=t.replace(r,'<img src="'+c+'" class="'+s[e].itemClassName+'" height='+o.tab.size+" />")}})}),n.parse(t)},i.parse=i.prototype.parse,"undefined"!=typeof $&&$.fn&&($.fn.emotion=function(t){return t=t||{},this.each(function(){new i(this,$.extend({},{input:"#"+$(this).data("target")},t))})},$.fn.emotion.parse=function(t){return i.prototype.parse(t,{size:20})},$.fn.emotion.show=function(t,o){return(new i).show(t,o)},$.fn.emotion.clearHistory=function(){return(new i).clearHistory()},$.fn.emotion.Constructor=i),module.exports=i});