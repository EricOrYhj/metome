define(function(require,exports,module){function t(){return!!(window.devicePixelRatio&&window.devicePixelRatio>1)}function e(t,e){if(t.createTextRange){var o=t.createTextRange();o.move("character",e),o.select()}else e?(t.focus(),t.setSelectionRange(e,e)):t.focus()}function o(t){var e=0;if(document.selection){t.focus();var o=document.selection.createRange(),i=o.duplicate();for(i.moveToElementText(t),e=-1;i.inRange(o);)i.moveStart("character"),e++}else t.setSelectionRange&&(t.focus(),e=t.selectionStart);return e}function i(t,e){this.$el=$(t),e.defaultTab=this.getDefaultTab(e),this.options=$.extend({},i.options,e),this._init()}require("./emotion.css");var n=require("twemoji");n.base="/resource/images/emotion/twemoji/",n.size=72,n.className="emotion-twemoji";var s=require("./data");i.prototype.getDefaultTab=function(t){var e="";return t=t||{},e=t.historyKey||i.options.historyKey,window.localStorage&&window.localStorage[e]?0:1},i.options={input:"",imgPath:"/resource/images/emotion/",defaultTab:0,mdBear:!1,offset:24,history:!0,historySize:40,autoHide:!0,historyKey:"mdEmotion",relatedLeftSpace:0,relatedTopSpace:0,placement:"left top",onSelect:function(){},onMDBearSelect:function(){}},i.prototype._init=function(){this.isOpen=!1,this.$target=$(this.options.input),this.$el.on("click",$.proxy(this.toggle,this)),this.$target.on("keyup",$.proxy(this.hide,this))},i.prototype.emotion=function(){var t=$('<div class="mdEmotion"><span class="arrow"></span> <div class="mdEmotionWrapper"></div><div class="mdEmotionTab"></div></div>'),e="",o="",i=this,n=null;return this.$emotion?n=this.$emotion:($.each(s,function(t,n){!i.options.mdBear&&"明道萌熊"===n.tab.name||!i.options.history&&0===t||(e+='<span class="tip-top tabItem tab'+(t+1)+(t===i.options.defaultTab?" active":"")+'" data-emotion-index="'+t+'" data-tip="'+n.tab.name+'"><i class="'+n.tab.className+'"></i>'+(n.tab.text||"")+"</span>",o+='<div class="mdEmotionPanel panel'+(t+1)+(t===i.options.defaultTab?" active":"")+'"></div>')}),t.find(".mdEmotionTab").html(e).end().find(".mdEmotionWrapper").html(o),n=t,this.$emotion=n,n)},i.prototype.arrow=function(){return this.$arrow=this.$arrow||this.emotion().find(".arrow"),this.$arrow},i.prototype._getPosition=function(){var t={top:0,left:0},e=this.options.placement.split(" "),o=this.$el.offset().top,i=this.emotion().outerHeight()+8,n=this.emotion().outerWidth()+8;return this.$el.length&&(t.left=this.$el.offset().left+this.options.relatedLeftSpace,t.top=this.$el.offset().top,$(window).height()-(o-$(window).scrollTop())<i?this.options.placement=e[0]+" top":this.options.placement=e[0]+" bottom",t.right-n<0&&(this.options.placement="left "+e[1]),e=this.options.placement.split(" "),"left"===e[0]?t.left+=0:"right"===e[0]&&(t.left-=n-this.$el.outerWidth()),"top"===e[1]?t.top-=i:"bottom"===e[1]&&(t.top+=this.$el.outerHeight()+8)),t},i.prototype._setPosition=function(t,e){this.$emotion.removeClass("emotion-top emotion-bottom"),this.$emotion.addClass("emotion-"+this.options.placement.split(" ")[1]);var o=this.options.placement.split(" ")[0];"left"===o?this.arrow().css("left",this.options.offset):"right"==o&&this.arrow().css("left",this.$emotion.outerWidth()-this.options.offset),this.emotion().offset({left:t,top:e})},i.prototype.select=function(t){t.stopPropagation();var i=t.currentTarget.outerHTML,n=t.currentTarget.getElementsByTagName("img")[0].getAttribute("src"),s=$(t.currentTarget),a="";this.options.autoHide&&this.hide(),s.hasClass("emotionItemBear")?(i=i.replace(" active","").replace(".gif",".png"),n=n.replace(".png",".gif"),this._storeHistory(i),"function"==typeof this.options.onMDBearSelect&&this.options.onMDBearSelect.call(this,t.currentTarget.getAttribute("title"),n.replace(this.options.imgPath,""))):s.hasClass("emoji")?(this._storeHistory(i),a=s.attr("title"),"function"==typeof this.options.onSelect&&this.options.onSelect.call(this,t.currentTarget.getAttribute("title"),n)):(this._storeHistory(i),a="["+t.currentTarget.getAttribute("title")+"]","function"==typeof this.options.onSelect&&this.options.onSelect.call(this,t.currentTarget.getAttribute("title"),n));var r=this.$target.val(),c=this.$target.get(0),l=o(c);this.$target.val(r.slice(0,l)+a+r.slice(l));var p=l+a.length;e(c,p),this.$target.focus()},i.prototype._storeHistory=function(t){if(window.localStorage){if(!window.localStorage[this.options.historyKey])return void(window.localStorage[this.options.historyKey]=JSON.stringify([t]));var e=JSON.parse(window.localStorage[this.options.historyKey]),o=$.inArray(t,e);o!==-1&&e.splice(o,1),e.unshift(t),e.length>this.options.historySize&&e.pop(),window.localStorage[this.options.historyKey]=JSON.stringify(e)}},i.prototype.clearHistory=function(){window.localStorage&&(window.localStorage[this.options.historyKey]=[])},i.prototype.show=function(t,e){var o=this;this.$emotion=this.emotion().on("click",".emotionItem",$.proxy(this.select,this)).insertAfter(this.$el).on("click",".mdEmotionTab .tabItem",function(){var t=$(this);return t.hasClass("active")||(t.siblings(".active").removeClass("active").end().addClass("active"),o.emotion().find(".mdEmotionPanel").removeClass("active").eq(t.index()).addClass("active"),o.load(t.data("emotion-index"))),!1}).on("mouseover",".emotionItemBear",function(){var t=$(this).toggleClass("active").find("img");t.attr("src",t.attr("src").replace(".png",".gif"))}).on("mouseout",".emotionItemBear",function(){var t=$(this).toggleClass("active").find("img");t.attr("src",t.attr("src").replace(".gif",".png"))});var i=o._getPosition();return t=t||i.left,e=e||i.top,this._setPosition(t,e),this.load(o.options.defaultTab),$(document).on("click.mdEmotion",function(t){$(t.target).closest(".mdEmotion").length||$.contains(o.$el[0],t.target)||o.$el[0]===t.target||o.hide()}),this.isOpen=!0,this.$emotion},i.prototype.load=function(e){var o=this.emotion().find(".panel"+(e+1)),i=this,a="";i.options.history&&0===e&&window.localStorage&&window.localStorage[this.options.historyKey]&&($.each(JSON.parse(window.localStorage[i.options.historyKey]),function(t,e){(i.options.mdBear||!i.options.mdBear&&e.indexOf("emotionItemBear")===-1)&&(a+=e)}),o.html(a)),o.data("loaded")||("emoji"===s[e].tab.type?$.each(s[e].content,function(t,o){a+='<a class="emotionItem '+s[e].tab.type+'" title="'+o+'">'+n.parse(o)+"</a>"}):$.each(s[e].content,function(o,n){a+='<a class="emotionItem '+("明道萌熊"===s[e].tab.name?"emotionItemBear":"")+'" title="'+n.key+'"><img src="'+i.options.imgPath+s[e].tab.path+(t()&&s[e].tab.showRetina?"retina/":"")+n.img+'"> </a>'}),o.html(a).data("loaded",!0))},i.prototype.hide=function(){this.$emotion&&(this.$emotion.remove(),$(document).off("click.mdEmotion"),this.isOpen=!1)},i.prototype.toggle=function(){this.isOpen?this.hide():this.show()},i.prototype.parse=function(e){return e=e||"",s.forEach(function(o,n){o.content.forEach(function(a,r){var c=new RegExp("\\["+a.key+"\\]","gi");if(e.search(c)>-1){"明道萌熊"===s[n].tab.name&&(a.img=a.img.replace(".png",".gif"));var l=i.options.imgPath+s[n].tab.path+(t()&&s[n].tab.showRetina?"retina/":"")+a.img;e=e.replace(c,'<img src="'+l+'" class="'+s[n].itemClassName+'" height='+o.tab.size+" />")}})}),n.parse(e)},i.parse=i.prototype.parse,"undefined"!=typeof $&&$.fn&&($.fn.emotion=function(t){return t=t||{},this.each(function(){new i(this,$.extend({},{input:"#"+$(this).data("target")},t))})},$.fn.emotion.parse=function(t){return i.prototype.parse(t,{size:20})},$.fn.emotion.show=function(t,e){return(new i).show(t,e)},$.fn.emotion.clearHistory=function(){return(new i).clearHistory()},$.fn.emotion.Constructor=i),module.exports=i});