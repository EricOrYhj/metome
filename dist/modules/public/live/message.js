define(function(require,exports,module){var t=require("../common/tool");require("../common/config"),require("../common/constant");var e={};e.options={uid:"",same:!1,me:!1},e.format=function(n,a){for(var o=[],i=0;i<n.length;i++){var r=!0,s=n[i];e.options.same=e.options.uid===s.uid,e.options.uid=s.uid,e.options.me=s.internalStatus>=2;var m=(s.atUid,{id:s.id,ctime:s.createTime,time:t.formatMsgTime(s.createTime),uid:s.uid,avatar:s.avatar+Config.AVATAR_100,placeholder:Config.avatarImgPath,uname:s.nickName,me:e.options.me,same:e.options.same,mid:s.fragmentId,ustatus:s.internalStatus,cidat:!1,uidat:!1});if(0!==s.contentType||0!==s.type&&1!==s.type)if(0===s.contentType&&4===s.type)m.type=Constant.MSGTYPE_TEXT,m.class="text",s.fragment=s.fragment,m.content=e.Emotion(s.fragment),m.content=e.Mark(s.fragment);else if(0===s.contentType&&3===s.type)m.type=Constant.MSGTYPE_FEEL,m.class="feel",s.fragment=s.fragment,m.content=e.Emotion(s.fragment);else if(1!==s.contentType||0!==s.type&&1!==s.type)if(13===s.type||13===s.contentType){m.type=Constant.MSGTYPE_AUDIO,m.class="audio msgCard";var p=JSON.parse(s.fragment),c=parseInt(p.duration/1e3),l=30;120/parseInt(p.duration/1e3)<3&&(l=100/parseInt(120/parseInt(p.duration/1e3))),m.file={original:s.fragmentImage,duration:c,width:l}}else if(12===s.type||12===s.contentType)m.type=Constant.MSGTYPE_VIDEO,m.class="video msgCard",m.file={original:s.fragment,placeholder:s.fragmentImage};else if(11===s.type||11===s.contentType){m.cidat=!0,m.type=Constant.MSGTYPE_TEXT,m.class="text";var f=JSON.parse(s.fragment),g=e.At(f.text,f.atStart,f.atEnd);m.content=e.Emotion(g)}else if(10===s.type||10===s.contentType){m.type=Constant.MSGTYPE_TEXT,m.class="text";var f=JSON.parse(s.fragment),g=e.At(f.text,f.atStart,f.atEnd);m.content=e.Emotion(g)}else r=!1;else m.type=Constant.MSGTYPE_PIC,m.class="pic msgCard",m.file={original:s.fragmentImage+Config.PREVIEW_IMG,placeholder:Config.placeholderImgPath};else m.type=Constant.MSGTYPE_TEXT,m.class="text",s.fragment=s.fragment,m.content=e.Emotion(s.fragment);r&&o.push(m)}return o},e.cover=function(n){n.title=e.Tag(n.title);var a={ctime:n.createTime,time:t.formatMsgTime(n.createTime),uid:n.uid,avatar:n.avatar+Config.AVATAR_100,placeholder:Config.avatarImgPath,uname:n.nickName,type:Constant.MSGTYPE_PIC,class:"pic msgCard",file:{original:n.coverImage+Config.PREVIEW_IMG,placeholder:Config.placeholderImgPath},title:n.title,reviewCount:n.reviewCount,topicCount:n.topicCount,zindex:10001};return a},e.Mark=function(t){return t='我感受到 <span class="audioColor"> 「'+t+"」</span>"},e.Tag=function(t){var e=(/^「(.*)」$/g.exec(t),new RegExp("\\「(.+)\\」","gi")),n=e.exec(t);return n&&n.length>0&&(t=t.replace(n[0],'<span class="audioColor">'+n[0]+"</span>")),t},e.At=function(t,e,n){var a=t.substr(e,n);return t=t.replace(a,'<span class="atColor">'+a+"&nbsp;&nbsp;</span>")},e.Emotion=function(t){return $.fn.emotion.parse(t)},module.exports=e});