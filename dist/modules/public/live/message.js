define(function(require,exports,module){var t=require("../common/tool");require("../common/config"),require("../common/constant");var e={};e.options={uid:"",same:!1,me:!1},e.format=function(a,n){for(var o=[],r=0;r<a.length;r++){var i=!0,s=a[r];e.options.same=e.options.uid===s.uid,e.options.uid=s.uid,e.options.me=s.internalStatus>=2,e.options.me||(e.options.me=s.uid===n);s.atUid;s.avatar&&s.avatar.indexOf("default.jpg")>0&&(s.avatar=Config.placeholderAvatar);var m={id:s.id,ctime:s.createTime,time:t.formatMsgTime(s.createTime),uid:s.uid,avatar:s.avatar+Config.AVATAR_100,placeholder:Config.placeholderAvatar,uname:s.nickName,me:e.options.me,same:e.options.same,mid:s.fragmentId,ustatus:s.internalStatus,cidat:!1,uidat:!1};if(0!==s.contentType||0!==s.type&&1!==s.type)if(0===s.contentType&&4===s.type)m.type=Constant.MSGTYPE_TEXT,m.class="text",s.fragment=s.fragment,m.content=e.Emotion(s.fragment),m.content=e.Mark(s.fragment);else if(0===s.contentType&&3===s.type)m.type=Constant.MSGTYPE_FEEL,m.class="feel",s.fragment=s.fragment,m.content=e.Emotion(s.fragment);else if(1!==s.contentType||0!==s.type&&1!==s.type)if(13===s.type||13===s.contentType){m.type=Constant.MSGTYPE_AUDIO,m.class="audio msgCard";var p=JSON.parse(s.fragment),c=parseInt(p.duration/1e3),l=30;120/parseInt(p.duration/1e3)<3&&(l=100/parseInt(120/parseInt(p.duration/1e3))),m.file={original:s.fragmentImage,duration:c,width:l}}else if(12===s.type||12===s.contentType)m.type=Constant.MSGTYPE_VIDEO,m.class="video msgCard",m.file={original:s.fragment,placeholder:s.fragmentImage};else if(11===s.type||11===s.contentType){m.cidat=!0,m.type=Constant.MSGTYPE_TEXT,m.class="text";var f=JSON.parse(s.fragment),g=e.At(f.text,f.atStart,f.atEnd);m.content=e.Emotion(g)}else if(10===s.type||10===s.contentType){m.type=Constant.MSGTYPE_TEXT,m.class="text";var f=JSON.parse(s.fragment),g=e.At(f.text,f.atStart,f.atEnd);m.content=e.Emotion(g)}else i=!1;else m.type=Constant.MSGTYPE_PIC,m.class="pic msgCard",m.file={original:s.fragmentImage+Config.PREVIEW_IMG,placeholder:Config.placeholderImgPath};else m.type=Constant.MSGTYPE_TEXT,m.class="text",s.fragment=s.fragment,m.content=e.Emotion(s.fragment);i&&o.push(m)}return o},e.cover=function(a){a.title=e.Tag(a.title);var n={ctime:a.createTime,time:t.formatMsgTime(a.createTime),uid:a.uid,avatar:a.avatar+Config.AVATAR_100,placeholder:Config.avatarImgPath,uname:a.nickName,type:Constant.MSGTYPE_PIC,class:"pic msgCard",file:{original:a.coverImage+Config.PREVIEW_IMG,placeholder:Config.placeholderImgPath},title:a.title,membersCount:a.membersCount,readCount:a.readCount,topicCount:a.topicCount,zindex:10001};return n},e.Mark=function(t){return t='我感受到 <span class="audioColor"> 「'+t+"」</span>"},e.Tag=function(t){var e=(/^「(.*)」$/g.exec(t),new RegExp("\\「(.+)\\」","gi")),a=e.exec(t);return a&&a.length>0&&(t=t.replace(a[0],'<span class="audioColor">'+a[0]+"</span>")),t},e.At=function(t,e,a){var n=t.substr(e,a);return t=t.replace(n,'<span class="atColor">'+n+"&nbsp;&nbsp;</span>")},e.Emotion=function(t){return $.fn.emotion.parse(t)},module.exports=e});