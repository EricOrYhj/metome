define(function(require,exports,module){var t=require("../common/tool");require("../common/config"),require("../common/constant");var e={};e.options={uid:"",same:!1,me:!1},e.format=function(n,a){for(var o=[],i=0;i<n.length;i++){var r=n[i];e.options.same=e.options.uid===r.uid,e.options.uid=r.uid,e.options.me=r.internalStatus>=2;var s=(r.atUid,{id:r.id,ctime:r.createTime,time:t.formatMsgTime(r.createTime),uid:r.uid,avatar:r.avatar+Config.AVATAR_100,placeholder:Config.avatarImgPath,uname:r.nickName,me:e.options.me,same:e.options.same,mid:r.fragmentId,ustatus:r.internalStatus,cidat:!1,uidat:!1});if(0!==r.contentType||0!==r.type&&1!==r.type)if(0===r.contentType&&4===r.type)s.type=Constant.MSGTYPE_TEXT,s.class="text",r.fragment=r.fragment,s.content=e.Emotion(r.fragment),s.content=e.Mark(r.fragment);else if(0===r.contentType&&3===r.type)s.type=Constant.MSGTYPE_FEEL,s.class="feel",r.fragment=r.fragment,s.content=e.Emotion(r.fragment);else if(1!==r.contentType||0!==r.type&&1!==r.type){if(13===r.type||13===r.contentType){s.type=Constant.MSGTYPE_AUDIO,s.class="audio msgCard";var m=JSON.parse(r.fragment),p=parseInt(m.duration/1e3),c=30;120/parseInt(m.duration/1e3)<3&&(c=100/parseInt(120/parseInt(m.duration/1e3))),s.file={original:r.fragmentImage,duration:p,width:c}}else if(12===r.type||12===r.contentType)s.type=Constant.MSGTYPE_VIDEO,s.class="video msgCard",s.file={original:r.fragment,placeholder:r.fragmentImage};else if(11===r.type||11===r.contentType){s.cidat=!0,s.type=Constant.MSGTYPE_TEXT,s.class="text";var l=JSON.parse(r.fragment),f=e.At(l.text,l.atStart,l.atEnd);s.content=e.Emotion(f)}else if(10===r.type||10===r.contentType){s.type=Constant.MSGTYPE_TEXT,s.class="text";var l=JSON.parse(r.fragment),f=e.At(l.text,l.atStart,l.atEnd);s.content=e.Emotion(f)}}else s.type=Constant.MSGTYPE_PIC,s.class="pic msgCard",s.file={original:r.fragmentImage+Config.PREVIEW_IMG,placeholder:Config.placeholderImgPath};else s.type=Constant.MSGTYPE_TEXT,s.class="text",r.fragment=r.fragment,s.content=e.Emotion(r.fragment);o.push(s)}return o},e.cover=function(n){n.title=e.Tag(n.title);var a={ctime:n.createTime,time:t.formatMsgTime(n.createTime),uid:n.uid,avatar:n.avatar+Config.AVATAR_100,placeholder:Config.avatarImgPath,uname:n.nickName,type:Constant.MSGTYPE_PIC,class:"pic msgCard",file:{original:n.coverImage+Config.PREVIEW_IMG,placeholder:Config.placeholderImgPath},title:n.title,reviewCount:n.reviewCount,topicCount:n.topicCount,zindex:10001};return a},e.Mark=function(t){return t='我感受到 <span class="audioColor"> 「'+t+"」</span>"},e.Tag=function(t){var e=(/^「(.*)」$/g.exec(t),new RegExp("\\「(.+)\\」","gi")),n=e.exec(t);return n&&n.length>0&&(t=t.replace(n[0],'<span class="audioColor">'+n[0]+"</span>")),t},e.At=function(t,e,n){var a=t.substr(e,n);return t=t.replace(a,'<span class="atColor">'+a+"&nbsp;&nbsp;</span>")},e.Emotion=function(t){return $.fn.emotion.parse(t)},module.exports=e});