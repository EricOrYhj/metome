define(function(require,exports,module){var o=require("dot"),t=require("../common/tool"),e=require("../server/server"),i=require("./message"),s=require("./tpl/footer.html"),n=require("./tpl/cover.html"),a=require("./tpl/msgme.html"),l=require("./tpl/msgmeat.html"),d=require("./tpl/msgyou.html"),m=require("./tpl/msgmelist.html"),p=require("./tpl/msgyoulist.html"),u={};u.options={topicId:"",cid:"",loading:!1,sinceId:0,lastisme:!1,lastisyou:!1,lastismeat:!1,zindex:1e4,msgmelistnum:1,msgyoulistnum:1,videoId:0};var c,r=$(".container"),v=$("body"),f=$("#header"),g=r.width()-2,h=$("#loading");u.GetLiveCover=function(){h.show(),e.GetLiveCover(u.options.topicId,function(e){if(e.data){e=e.data,u.options.cid=e.uid;var a=i.cover(e),l=$(o.template(n)(a));r.prepend(l),t.lazyload(l),c=$(o.template(s)(a)),v.append(c),document.title=a.title+" @"+a.uname+" --米汤",document.getElementById("description").content="@"+a.uname+"正在meTome王国中讲述想法和故事"}else 500===e.code?alert("该直播间已关闭"):alert("发生错误")})};var y;u.GetLiveTimeLine=function(){h.show(),e.GetLiveTimeLine(u.options.topicId,u.options.sinceId,function(o){o.data?u.options.cid?u.CreateMessageItem(o.data.liveElements):y=setInterval(function(){u.CreateMessageItem(o.data.liveElements)},0):500===o.code?alert("该直播间已关闭"):alert("发生错误")})},u.CreateMessageItem=function(t){if(u.options.cid){clearInterval(y);var e=i.format(t,u.options.cid);e.forEach(function(t,e){if(5===t.type&&(t.width=g,u.options.videoId++,t.videoid=u.options.videoId),t.me&&!t.cidat){if(u.options.lastismeat&&(t.same=!1),u.options.lastisme){u.options.msgmelistnum--;var i=$("#mml_"+u.options.msgmelistnum);i.append($(o.template(a)(t))),u.options.msgmelistnum++}else{var i=$(o.template(m)(u.options.msgmelistnum));i.append($(o.template(a)(t))),r.append(i),u.options.msgmelistnum++}u.options.lastisme=!0,u.options.lastisyou=!1,u.options.lastismeat=!1,5===t.type&&require.async(["video","videocss"],function(){setTimeout(function(){videojs("video_"+u.options.videoId,{},function(){console.log("video_"+u.options.videoId+"Good to go!"),$(this).find(".vjs-big-play-button").on("click",function(){this.play()}),this.on("ended",function(){console.log("awww...over so soon?")})})},0)})}else{var s;if(t.cidat?(u.options.lastismeat=!0,s=$(o.template(l)(t))):(u.options.lastismeat=!1,s=$(o.template(d)(t))),u.options.lastisyou){u.options.msgyoulistnum--;var n=$("#myl_"+u.options.msgyoulistnum);n.append(s),u.options.msgyoulistnum++}else{var n=$(o.template(p)(u.options.msgyoulistnum));n.append(s),r.append(n),u.options.msgyoulistnum++}u.options.lastisme=!1,u.options.lastisyou=!0}u.options.sinceId=t.mid}),require.async("scrollLoading",function(){$(".scrollLoading").scrollLoading()}),r.on("click",".msgItem.audio",u.PlayAudio),r.on("click",".msgItem .feelItem",function(){var o=$(this),t=o.find(".feelImg");t.hasClass("feelRotate180")?(o.find(".title").show(500),t.removeClass("feelRotate180").addClass("feelRotate0")):(o.find(".title").hide(500),t.removeClass("feelRotate0").addClass("feelRotate180"))}),setTimeout(function(){u.options.loading=!1},500),h.hide()}},u.PlayAudio=function(){var o=$(this);require.async("mp3player",function(t){var e=o.closest(".msgItem"),i=e.find(".audioInfo").data("audio"),s=e.data("audio");window.chatAudioPlayer&&window.chatAudioPlayer.stop(),s?e.hasClass("audioAnimation")?(s.stop(),window.chatAudioPlayer.stop()):(window.chatAudioPlayer=s,window.chatAudioPlayer.play(),e.addClass("audioAnimation")):(s=new t({mp3_url:i,wav_url:i,onStop:function(){e.removeClass("audioAnimation")}}),window.chatAudioPlayer=s,window.chatAudioPlayer.play(),e.addClass("audioAnimation").data("audio",s))})};var w=0;$(document).scroll(function(){var o=$(document).scrollTop(),t=$(window).height(),e=$(document).height();o+t+10>=e&&!u.options.loading&&(u.options.loading=!0,u.GetLiveTimeLine()),w-o>0?(f.removeClass("headerAnimationTop").addClass("headerAnimationDown"),c.removeClass("footerAnimationTop").addClass("footerAnimationDown")):o>50&&o-w>50&&(f.removeClass("headerAnimationDown").addClass("headerAnimationTop"),c.removeClass("footerAnimationDown").addClass("footerAnimationTop")),o<=50&&(c.show(),f.show()),w=o}),module.exports=u});