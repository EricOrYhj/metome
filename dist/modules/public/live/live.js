define(function(require,exports,module){var o=require("dot"),i=require("../common/tool"),t=require("../server/server"),n=require("./message"),s=require("./tpl/cover.html"),e=require("./tpl/msgme.html"),a=require("./tpl/msgyou.html"),l=require("./tpl/msgmelist.html"),d=require("./tpl/msgyoulist.html"),m=$(".container"),p=m.width()-2,u={};u.options={topicId:"",cid:"",loading:!1,sinceId:0,lastisme:!1,lastisyou:!1,zindex:1e4,msgmelistnum:1,msgyoulistnum:1,videoId:0},u.GetLiveCover=function(){t.GetLiveCover(u.options.topicId,function(t){t=t.data,u.options.cid=t.uid;var e=n.cover(t),a=$(o.template(s)(e));m.prepend(a),i.lazyload(a)})};var c;u.GetLiveTimeLine=function(){t.GetLiveTimeLine(u.options.topicId,u.options.sinceId,function(o){c=setInterval(function(){u.CreateMessageItem(o.data.liveElements)},1)})},u.CreateMessageItem=function(i){if(u.options.cid){clearInterval(c);var t=n.format(i,u.options.cid);t.forEach(function(i,t){if(5===i.type&&(i.width=p,u.options.videoId++,i.videoid=u.options.videoId),i.me){if(u.options.lastisme){u.options.msgmelistnum--;var n=$("#mml_"+u.options.msgmelistnum);n.append($(o.template(e)(i))),u.options.msgmelistnum++}else{var n=$(o.template(l)(u.options.msgmelistnum));n.append($(o.template(e)(i))),m.append(n),u.options.msgmelistnum++}u.options.lastisme=!0,u.options.lastisyou=!1,5===i.type&&require.async(["video","videocss"],function(){setTimeout(function(){videojs("video_"+u.options.videoId,{},function(){console.log("video_"+u.options.videoId+"Good to go!"),$(this).find(".vjs-big-play-button").on("click",function(){this.play()}),this.on("ended",function(){console.log("awww...over so soon?")})})},0)})}else{if(u.options.lastisyou){u.options.msgyoulistnum--;var s=$("#myl_"+u.options.msgyoulistnum);s.append($(o.template(a)(i))),u.options.msgyoulistnum++}else{var s=$(o.template(d)(u.options.msgyoulistnum));s.append($(o.template(a)(i))),m.append(s),u.options.msgyoulistnum++}u.options.lastisme=!1,u.options.lastisyou=!0}u.options.sinceId=i.mid}),require.async("scrollLoading",function(){$(".scrollLoading").scrollLoading()}),m.on("click",".msgItem.audio",u.PlayAudio),u.options.loading=!1}},u.PlayAudio=function(){var o=$(this);require.async("mp3player",function(i){var t=o.closest(".msgItem"),n=t.find(".audioInfo").data("audio"),s=t.data("audio");window.chatAudioPlayer&&window.chatAudioPlayer.stop(),s?t.hasClass("audioPlaying")?(s.stop(),window.chatAudioPlayer.stop()):(window.chatAudioPlayer=s,window.chatAudioPlayer.play(),t.addClass("audioPlaying")):(s=new i({mp3_url:n,wav_url:n,onStop:function(){t.removeClass("audioPlaying")}}),window.chatAudioPlayer=s,window.chatAudioPlayer.play(),t.addClass("audioPlaying").data("audio",s))})},$(document).scroll(function(){var o=$(document).scrollTop(),i=$(window).height(),t=$(document).height();o+i+10>=t&&!u.options.loading&&(console.log(u.options.sinceId),console.log(u.options.loading),u.options.loading=u.GetLiveTimeLine())}),module.exports=u});