define(function(require,exports,module){var o=require("dot"),i=require("../common/tool"),t=require("../server/server"),e=require("./message"),n=require("./tpl/cover.html"),s=require("./tpl/msgme.html"),a=require("./tpl/msgmeat.html"),l=require("./tpl/msgyou.html"),d=require("./tpl/msgmelist.html"),m=require("./tpl/msgyoulist.html"),p=$(".container"),u=p.width()-2,c={};c.options={topicId:"",cid:"",loading:!1,sinceId:0,lastisme:!1,lastisyou:!1,zindex:1e4,msgmelistnum:1,msgyoulistnum:1,videoId:0},c.GetLiveCover=function(){t.GetLiveCover(c.options.topicId,function(t){t=t.data,c.options.cid=t.uid;var s=e.cover(t),a=$(o.template(n)(s));p.prepend(a),i.lazyload(a)})};var r;c.GetLiveTimeLine=function(){t.GetLiveTimeLine(c.options.topicId,c.options.sinceId,function(o){r=setInterval(function(){c.CreateMessageItem(o.data.liveElements)},1)})},c.CreateMessageItem=function(i){if(c.options.cid){clearInterval(r);var t=e.format(i,c.options.cid);t.forEach(function(i,t){if(5===i.type&&(i.width=u,c.options.videoId++,i.videoid=c.options.videoId),i.me&&!i.cidat){if(i.zindex=c.options.zindex,c.options.zindex--,c.options.lastisme){c.options.msgmelistnum--;var e=$("#mml_"+c.options.msgmelistnum);e.append($(o.template(s)(i))),c.options.msgmelistnum++}else{var e=$(o.template(d)(c.options.msgmelistnum));e.append($(o.template(s)(i))),p.append(e),c.options.msgmelistnum++}c.options.lastisme=!0,c.options.lastisyou=!1,5===i.type&&require.async(["video","videocss"],function(){setTimeout(function(){videojs("video_"+c.options.videoId,{},function(){console.log("video_"+c.options.videoId+"Good to go!"),$(this).find(".vjs-big-play-button").on("click",function(){this.play()}),this.on("ended",function(){console.log("awww...over so soon?")})})},0)})}else{var n;if(n=i.cidat?$(o.template(a)(i)):$(o.template(l)(i)),c.options.lastisyou){c.options.msgyoulistnum--;var r=$("#myl_"+c.options.msgyoulistnum);r.append(n),c.options.msgyoulistnum++}else{var r=$(o.template(m)(c.options.msgyoulistnum));r.append(n),p.append(r),c.options.msgyoulistnum++}c.options.lastisme=!1,c.options.lastisyou=!0}c.options.sinceId=i.mid}),require.async("scrollLoading",function(){$(".scrollLoading").scrollLoading()}),p.on("click",".msgItem.audio",c.PlayAudio),p.on("click",".msgItem .feelItem",function(){var o=$(this),i=o.find(".feelImg");i.hasClass("feelRotate180")?(o.find(".title").show(500),i.removeClass("feelRotate180").addClass("feelRotate0")):(o.find(".title").hide(500),i.removeClass("feelRotate0").addClass("feelRotate180"))}),c.options.loading=!1}},c.PlayAudio=function(){var o=$(this);require.async("mp3player",function(i){var t=o.closest(".msgItem"),e=t.find(".audioInfo").data("audio"),n=t.data("audio");window.chatAudioPlayer&&window.chatAudioPlayer.stop(),n?t.hasClass("audioPlaying")?(n.stop(),window.chatAudioPlayer.stop()):(window.chatAudioPlayer=n,window.chatAudioPlayer.play(),t.addClass("audioPlaying")):(n=new i({mp3_url:e,wav_url:e,onStop:function(){t.removeClass("audioPlaying")}}),window.chatAudioPlayer=n,window.chatAudioPlayer.play(),t.addClass("audioPlaying").data("audio",n))})},$(document).scroll(function(){var o=$(document).scrollTop(),i=$(window).height(),t=$(document).height();o+i+10>=t&&!c.options.loading&&(console.log(c.options.sinceId),console.log(c.options.loading),c.options.loading=c.GetLiveTimeLine())}),module.exports=c});