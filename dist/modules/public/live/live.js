define(function(require,exports,module){var o,t=require("dot"),i=require("../common/tool"),e=require("../server/server"),n=require("./message"),s=require("./tpl/footer.html"),a=require("./tpl/cover.html"),l=require("./tpl/msgme.html"),d=require("./tpl/msgmeat.html"),m=require("./tpl/msgyou.html"),p=require("./tpl/msgmelist.html"),u=require("./tpl/msgyoulist.html"),c=require("./tpl/loading.html"),r=$(".container"),v=$("body"),f=$("#header"),h=r.width()-2,g={};g.options={topicId:"",cid:"",loading:!1,sinceId:0,lastisme:!1,lastisyou:!1,lastismeat:!1,zindex:1e4,msgmelistnum:1,msgyoulistnum:1,videoId:0};var y=$(t.template(c)());v.append(y),g.GetLiveCover=function(){y=$("#loading"),y.show(),e.GetLiveCover(g.options.topicId,function(e){e=e.data,g.options.cid=e.uid;var l=n.cover(e),d=$(t.template(a)(l));r.prepend(d),i.lazyload(d),o=$(t.template(s)(l)),v.append(o),document.title=l.title+" @"+l.uname+" --米汤",document.getElementById("description").content="@"+l.uname+"正在meTome王国中讲述想法和故事"})};var w;g.GetLiveTimeLine=function(){y.show(),e.GetLiveTimeLine(g.options.topicId,g.options.sinceId,function(o){w=setInterval(function(){g.CreateMessageItem(o.data.liveElements)},1)})},g.CreateMessageItem=function(o){if(g.options.cid){clearInterval(w);var i=n.format(o,g.options.cid);i.forEach(function(o,i){if(5===o.type&&(o.width=h,g.options.videoId++,o.videoid=g.options.videoId),o.me&&!o.cidat){if(g.options.lastismeat&&(o.same=!1),g.options.lastisme){g.options.msgmelistnum--;var e=$("#mml_"+g.options.msgmelistnum);e.append($(t.template(l)(o))),g.options.msgmelistnum++}else{var e=$(t.template(p)(g.options.msgmelistnum));e.append($(t.template(l)(o))),r.append(e),g.options.msgmelistnum++}g.options.lastisme=!0,g.options.lastisyou=!1,5===o.type&&require.async(["video","videocss"],function(){setTimeout(function(){videojs("video_"+g.options.videoId,{},function(){console.log("video_"+g.options.videoId+"Good to go!"),$(this).find(".vjs-big-play-button").on("click",function(){this.play()}),this.on("ended",function(){console.log("awww...over so soon?")})})},0)})}else{var n;if(o.cidat?(g.options.lastismeat=!0,n=$(t.template(d)(o))):(g.options.lastismeat=!1,n=$(t.template(m)(o))),g.options.lastisyou){g.options.msgyoulistnum--;var s=$("#myl_"+g.options.msgyoulistnum);s.append(n),g.options.msgyoulistnum++}else{var s=$(t.template(u)(g.options.msgyoulistnum));s.append(n),r.append(s),g.options.msgyoulistnum++}g.options.lastisme=!1,g.options.lastisyou=!0}g.options.sinceId=o.mid}),require.async("scrollLoading",function(){$(".scrollLoading").scrollLoading()}),r.on("click",".msgItem.audio",g.PlayAudio),r.on("click",".msgItem .feelItem",function(){var o=$(this),t=o.find(".feelImg");t.hasClass("feelRotate180")?(o.find(".title").show(500),t.removeClass("feelRotate180").addClass("feelRotate0")):(o.find(".title").hide(500),t.removeClass("feelRotate0").addClass("feelRotate180"))}),g.options.loading=!1,y.hide()}},g.PlayAudio=function(){var o=$(this);require.async("mp3player",function(t){var i=o.closest(".msgItem"),e=i.find(".audioInfo").data("audio"),n=i.data("audio");window.chatAudioPlayer&&window.chatAudioPlayer.stop(),n?i.hasClass("audioAnimation")?(n.stop(),window.chatAudioPlayer.stop()):(window.chatAudioPlayer=n,window.chatAudioPlayer.play(),i.addClass("audioAnimation")):(n=new t({mp3_url:e,wav_url:e,onStop:function(){i.removeClass("audioAnimation")}}),window.chatAudioPlayer=n,window.chatAudioPlayer.play(),i.addClass("audioAnimation").data("audio",n))})};var I=0;$(document).scroll(function(){var t=$(document).scrollTop(),i=$(window).height(),e=$(document).height();t+i+10>=e&&!g.options.loading&&(g.options.loading=g.GetLiveTimeLine()),I-t>0?(f.removeClass("headerAnimationTop").addClass("headerAnimationDown"),o.removeClass("footerAnimationTop").addClass("footerAnimationDown")):t>50&&t-I>50&&(f.removeClass("headerAnimationDown").addClass("headerAnimationTop"),o.removeClass("footerAnimationDown").addClass("footerAnimationTop")),t<=50&&(o.show(),f.show()),I=t}),module.exports=g});