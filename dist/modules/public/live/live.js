define(function(require,exports,module){var o=require("dot"),t=require("../common/tool"),e=require("../server/server"),i=require("./message"),n=require("./tpl/footer.html"),s=require("./tpl/cover.html"),a=require("./tpl/msgme.html"),l=require("./tpl/msgmeat.html"),d=require("./tpl/msgyou.html"),m=require("./tpl/msgmelist.html"),p=require("./tpl/msgyoulist.html"),u=require("./tpl/loading.html"),c={};c.options={topicId:"",cid:"",loading:!1,sinceId:0,lastisme:!1,lastisyou:!1,lastismeat:!1,zindex:1e4,msgmelistnum:1,msgyoulistnum:1,videoId:0};var r,v=$(".container"),f=$("body"),g=$("#header"),h=v.width()-2,y=$(o.template(u)());f.append(y),c.GetLiveCover=function(){y=$("#loading"),y.show(),e.GetLiveCover(c.options.topicId,function(e){e=e.data,c.options.cid=e.uid;var a=i.cover(e),l=$(o.template(s)(a));v.prepend(l),t.lazyload(l),r=$(o.template(n)(a)),f.append(r),document.title=a.title+" @"+a.uname+" --米汤",document.getElementById("description").content="@"+a.uname+"正在meTome王国中讲述想法和故事"})};var w;c.GetLiveTimeLine=function(){y.show(),e.GetLiveTimeLine(c.options.topicId,c.options.sinceId,function(o){c.options.cid?c.CreateMessageItem(o.data.liveElements):w=setInterval(function(){c.CreateMessageItem(o.data.liveElements)},0)})},c.CreateMessageItem=function(t){if(c.options.cid){clearInterval(w);var e=i.format(t,c.options.cid);e.forEach(function(t,e){if(5===t.type&&(t.width=h,c.options.videoId++,t.videoid=c.options.videoId),t.me&&!t.cidat){if(c.options.lastismeat&&(t.same=!1),c.options.lastisme){c.options.msgmelistnum--;var i=$("#mml_"+c.options.msgmelistnum);i.append($(o.template(a)(t))),c.options.msgmelistnum++}else{var i=$(o.template(m)(c.options.msgmelistnum));i.append($(o.template(a)(t))),v.append(i),c.options.msgmelistnum++}c.options.lastisme=!0,c.options.lastisyou=!1,5===t.type&&require.async(["video","videocss"],function(){setTimeout(function(){videojs("video_"+c.options.videoId,{},function(){console.log("video_"+c.options.videoId+"Good to go!"),$(this).find(".vjs-big-play-button").on("click",function(){this.play()}),this.on("ended",function(){console.log("awww...over so soon?")})})},0)})}else{var n;if(t.cidat?(c.options.lastismeat=!0,n=$(o.template(l)(t))):(c.options.lastismeat=!1,n=$(o.template(d)(t))),c.options.lastisyou){c.options.msgyoulistnum--;var s=$("#myl_"+c.options.msgyoulistnum);s.append(n),c.options.msgyoulistnum++}else{var s=$(o.template(p)(c.options.msgyoulistnum));s.append(n),v.append(s),c.options.msgyoulistnum++}c.options.lastisme=!1,c.options.lastisyou=!0}c.options.sinceId=t.mid}),require.async("scrollLoading",function(){$(".scrollLoading").scrollLoading()}),v.on("click",".msgItem.audio",c.PlayAudio),v.on("click",".msgItem .feelItem",function(){var o=$(this),t=o.find(".feelImg");t.hasClass("feelRotate180")?(o.find(".title").show(500),t.removeClass("feelRotate180").addClass("feelRotate0")):(o.find(".title").hide(500),t.removeClass("feelRotate0").addClass("feelRotate180"))}),setTimeout(function(){c.options.loading=!1},0),y.hide()}},c.PlayAudio=function(){var o=$(this);require.async("mp3player",function(t){var e=o.closest(".msgItem"),i=e.find(".audioInfo").data("audio"),n=e.data("audio");window.chatAudioPlayer&&window.chatAudioPlayer.stop(),n?e.hasClass("audioAnimation")?(n.stop(),window.chatAudioPlayer.stop()):(window.chatAudioPlayer=n,window.chatAudioPlayer.play(),e.addClass("audioAnimation")):(n=new t({mp3_url:i,wav_url:i,onStop:function(){e.removeClass("audioAnimation")}}),window.chatAudioPlayer=n,window.chatAudioPlayer.play(),e.addClass("audioAnimation").data("audio",n))})};var I=0;$(document).scroll(function(){var o=$(document).scrollTop(),t=$(window).height(),e=$(document).height();o+t+10>=e&&!c.options.loading&&(c.options.loading=!0,c.GetLiveTimeLine()),I-o>0?(g.removeClass("headerAnimationTop").addClass("headerAnimationDown"),r.removeClass("footerAnimationTop").addClass("footerAnimationDown")):o>50&&o-I>50&&(g.removeClass("headerAnimationDown").addClass("headerAnimationTop"),r.removeClass("footerAnimationDown").addClass("footerAnimationTop")),o<=50&&(r.show(),g.show()),I=o}),module.exports=c});