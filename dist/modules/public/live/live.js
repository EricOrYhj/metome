define(function(require,exports,module){var o=require("dot"),i=require("../common/tool"),t=require("../server/server"),e=require("./message"),n=require("./tpl/cover.html"),s=require("./tpl/msgme.html"),a=require("./tpl/msgmeat.html"),l=require("./tpl/msgyou.html"),d=require("./tpl/msgmelist.html"),m=require("./tpl/msgyoulist.html"),p=require("./tpl/loading.html"),u=$(".container"),c=u.width()-2,r={};r.options={topicId:"",cid:"",loading:!1,sinceId:0,lastisme:!1,lastisyou:!1,zindex:1e4,msgmelistnum:1,msgyoulistnum:1,videoId:0};var v=$(o.template(p)());$("body").append(v),r.GetLiveCover=function(){v=$("#loading"),v.show(),t.GetLiveCover(r.options.topicId,function(t){t=t.data,r.options.cid=t.uid;var s=e.cover(t),a=$(o.template(n)(s));u.prepend(a),i.lazyload(a)})};var g;r.GetLiveTimeLine=function(){v.show(),t.GetLiveTimeLine(r.options.topicId,r.options.sinceId,function(o){g=setInterval(function(){r.CreateMessageItem(o.data.liveElements)},1)})},r.CreateMessageItem=function(i){if(r.options.cid){clearInterval(g);var t=e.format(i,r.options.cid);t.forEach(function(i,t){if(5===i.type&&(i.width=c,r.options.videoId++,i.videoid=r.options.videoId),i.me&&!i.cidat){if(i.zindex=r.options.zindex,r.options.zindex--,r.options.lastisme){r.options.msgmelistnum--;var e=$("#mml_"+r.options.msgmelistnum);e.append($(o.template(s)(i))),r.options.msgmelistnum++}else{var e=$(o.template(d)(r.options.msgmelistnum));e.append($(o.template(s)(i))),u.append(e),r.options.msgmelistnum++}r.options.lastisme=!0,r.options.lastisyou=!1,5===i.type&&require.async(["video","videocss"],function(){setTimeout(function(){videojs("video_"+r.options.videoId,{},function(){console.log("video_"+r.options.videoId+"Good to go!"),$(this).find(".vjs-big-play-button").on("click",function(){this.play()}),this.on("ended",function(){console.log("awww...over so soon?")})})},0)})}else{var n;if(n=i.cidat?$(o.template(a)(i)):$(o.template(l)(i)),r.options.lastisyou){r.options.msgyoulistnum--;var p=$("#myl_"+r.options.msgyoulistnum);p.append(n),r.options.msgyoulistnum++}else{var p=$(o.template(m)(r.options.msgyoulistnum));p.append(n),u.append(p),r.options.msgyoulistnum++}r.options.lastisme=!1,r.options.lastisyou=!0}r.options.sinceId=i.mid}),require.async("scrollLoading",function(){$(".scrollLoading").scrollLoading()}),u.on("click",".msgItem.audio",r.PlayAudio),u.on("click",".msgItem .feelItem",function(){var o=$(this),i=o.find(".feelImg");i.hasClass("feelRotate180")?(o.find(".title").show(500),i.removeClass("feelRotate180").addClass("feelRotate0")):(o.find(".title").hide(500),i.removeClass("feelRotate0").addClass("feelRotate180"))}),r.options.loading=!1,v.hide()}},r.PlayAudio=function(){var o=$(this);require.async("mp3player",function(i){var t=o.closest(".msgItem"),e=t.find(".audioInfo").data("audio"),n=t.data("audio");window.chatAudioPlayer&&window.chatAudioPlayer.stop(),n?t.hasClass("audioPlaying")?(n.stop(),window.chatAudioPlayer.stop()):(window.chatAudioPlayer=n,window.chatAudioPlayer.play(),t.addClass("audioPlaying")):(n=new i({mp3_url:e,wav_url:e,onStop:function(){t.removeClass("audioPlaying")}}),window.chatAudioPlayer=n,window.chatAudioPlayer.play(),t.addClass("audioPlaying").data("audio",n))})};var f=0,y=0;$(document).scroll(function(){var o=$(document).scrollTop(),i=$(window).height(),t=$(document).height();o+i+10>=t&&!r.options.loading&&(r.options.loading=r.GetLiveTimeLine());var e=$("#footer");y=$(document).scrollTop(),f-y>100?e.show():e.hide(),f=y}),module.exports=r});