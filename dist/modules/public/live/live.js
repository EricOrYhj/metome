define(function(require,exports,module){var o=require("dot"),t=require("../common/tool"),i=require("../server/server"),e=require("./message"),s=require("./tpl/cover.html"),n=require("./tpl/msgme.html"),a=require("./tpl/msgmeat.html"),l=require("./tpl/msgyou.html"),d=require("./tpl/msgmelist.html"),m=require("./tpl/msgyoulist.html"),p=require("./tpl/loading.html"),u=$(".container"),c=u.width()-2,r={};r.options={topicId:"",cid:"",loading:!1,sinceId:0,lastisme:!1,lastisyou:!1,lastismeat:!1,zindex:1e4,msgmelistnum:1,msgyoulistnum:1,videoId:0};var v=$(o.template(p)());$("body").append(v),r.GetLiveCover=function(){v=$("#loading"),v.show(),i.GetLiveCover(r.options.topicId,function(i){i=i.data,r.options.cid=i.uid;var n=e.cover(i),a=$(o.template(s)(n));u.prepend(a),t.lazyload(a)})};var g;r.GetLiveTimeLine=function(){v.show(),i.GetLiveTimeLine(r.options.topicId,r.options.sinceId,function(o){g=setInterval(function(){r.CreateMessageItem(o.data.liveElements)},1)})},r.CreateMessageItem=function(t){if(r.options.cid){clearInterval(g);var i=e.format(t,r.options.cid);i.forEach(function(t,i){if(5===t.type&&(t.width=c,r.options.videoId++,t.videoid=r.options.videoId),t.me&&!t.cidat){if(r.options.lastismeat&&(t.same=!1),r.options.lastisme){r.options.msgmelistnum--;var e=$("#mml_"+r.options.msgmelistnum);e.append($(o.template(n)(t))),r.options.msgmelistnum++}else{var e=$(o.template(d)(r.options.msgmelistnum));e.append($(o.template(n)(t))),u.append(e),r.options.msgmelistnum++}r.options.lastisme=!0,r.options.lastisyou=!1,5===t.type&&require.async(["video","videocss"],function(){setTimeout(function(){videojs("video_"+r.options.videoId,{},function(){console.log("video_"+r.options.videoId+"Good to go!"),$(this).find(".vjs-big-play-button").on("click",function(){this.play()}),this.on("ended",function(){console.log("awww...over so soon?")})})},0)})}else{var s;if(t.cidat?(r.options.lastismeat=!0,s=$(o.template(a)(t))):(r.options.lastismeat=!1,s=$(o.template(l)(t))),r.options.lastisyou){r.options.msgyoulistnum--;var p=$("#myl_"+r.options.msgyoulistnum);p.append(s),r.options.msgyoulistnum++}else{var p=$(o.template(m)(r.options.msgyoulistnum));p.append(s),u.append(p),r.options.msgyoulistnum++}r.options.lastisme=!1,r.options.lastisyou=!0}r.options.sinceId=t.mid}),require.async("scrollLoading",function(){$(".scrollLoading").scrollLoading()}),u.on("click",".msgItem.audio",r.PlayAudio),u.on("click",".msgItem .feelItem",function(){var o=$(this),t=o.find(".feelImg");t.hasClass("feelRotate180")?(o.find(".title").show(500),t.removeClass("feelRotate180").addClass("feelRotate0")):(o.find(".title").hide(500),t.removeClass("feelRotate0").addClass("feelRotate180"))}),r.options.loading=!1,v.hide()}},r.PlayAudio=function(){var o=$(this);require.async("mp3player",function(t){var i=o.closest(".msgItem"),e=i.find(".audioInfo").data("audio"),s=i.data("audio");window.chatAudioPlayer&&window.chatAudioPlayer.stop(),s?i.hasClass("audioPlaying")?(s.stop(),window.chatAudioPlayer.stop()):(window.chatAudioPlayer=s,window.chatAudioPlayer.play(),i.addClass("audioPlaying")):(s=new t({mp3_url:e,wav_url:e,onStop:function(){i.removeClass("audioPlaying")}}),window.chatAudioPlayer=s,window.chatAudioPlayer.play(),i.addClass("audioPlaying").data("audio",s))})};var f=0,y=0;$(document).scroll(function(){var o=$(document).scrollTop(),t=$(window).height(),i=$(document).height();o+t+10>=i&&!r.options.loading&&(r.options.loading=r.GetLiveTimeLine());var e=$("#footer");y=$(document).scrollTop(),f-y>100?e.show():e.hide(),f=y}),module.exports=r});